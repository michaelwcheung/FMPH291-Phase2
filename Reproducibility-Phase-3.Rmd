---
title: "Reproducing Group-1's Findings"
author: "Arnab Dey, Michael Cheung"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  slidy_presentation:
    highlight: tango
    slide_level: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load-packages}
library(tidyverse)
library(stringr)
library(summarytools)
library(compareGroups)
library(cobalt)
```

```{r load-dataset}
# setwd("~/Documents/FMPH291 Reproducibility/Data")
df_master <- read.csv("group3_LATE_47215_3615162_DHS_shared-2.csv")

```

```{r filter cases}

df_study <- df_master %>% 
  filter(v044 == 1) %>%     # Cases selected for IPV module
  filter(v502 == 1) %>%     # Drop cases that are not in union now
  filter(str_sub(vcal_1,1,1) != 6) %>%  # Drop cases of sterilization
  filter(v701 != 8) %>%     # Drop those who do not know spousal edu
  filter(s116 != 8)      # Drop those who do not report caste
  

## Remove non-users
df_study$any_digit <- grepl("[123456789]", df_study$vcal_1)
df_study$any_valid_letter <- grepl("[ACEFLMNSW]", df_study$vcal_1)

# variable for cases who use any method
df_study$any_method <- ifelse(df_study$any_digit == TRUE | df_study$any_valid_letter == TRUE,1,0)

# final dataset with valid cases
df_study <- df_study %>% filter(any_method == 1)

#clean covariates
df_study <- df_study %>%
  dplyr::rename(age = 'v012',
         educ = 'v106',
         sp_educ = 'v701',
         wealth = 'v190',
         residence = 'v025',
         caste = 's116',
         religion = 'v130') %>%
  mutate(sons = v202 + v204,
         daughters = v203 + v205)
  
#clean exposure
IPV_items <- names(select(df_study, starts_with("d105")))
df_study$faced_IPV <- ifelse(rowSums(df_study[,IPV_items], na.rm = T) > 0, 1, 0)

#function to determine if contraceptives were stopped during 12 months prior to interview
contraceptives_stopped <- function(vcal, start, stop){
  contraceptives = unlist(str_locate_all(vcal, pattern = start))
  not_contraceptives = unlist(str_locate_all(vcal, pattern = stop))
  not_contraceptives = ifelse(length(not_contraceptives) == 0, 13, not_contraceptives)

  earliest_contraceptives = max(contraceptives)
  latest_not_contraceptive = min(not_contraceptives)

  return(latest_not_contraceptive < earliest_contraceptives)
}

#clean outcome
stop_contraceptive_chars <- c("0", "P", "T", "B")
contraceptive_chars <- c("A", "C", "E", "F", "L", "M", "N", "S", "W", 
                         "1", "2", "3", "4", "5", "6", "7", "8", "9")
#apparently this isn't correct, they just counted any string that contained 0PTB as stopped using contraceptives
# df_study$contraceptives_discontinued <- sapply(df_study$vcal_1, 
#        function(x) contraceptives_stopped(x, start = contraceptive_chars, stop = stop_contraceptive_chars))

df_study$contraceptives_discontinued <- grepl("[0PTB]", df_study$vcal_1)

#select variables for analyses
exposure <- "faced_IPV"
outcome <- "contraceptives_discontinued"
covariates <- c("age", "educ", "sp_educ", "wealth", "residence", "sons", "daughters", "caste", "religion")

df_study <- select(df_study, exposure, outcome, all_of(covariates))

```
